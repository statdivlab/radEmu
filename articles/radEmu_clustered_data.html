<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="radEmu">
<title>Using radEmu on clustered data • radEmu</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using radEmu on clustered data">
<meta property="og:description" content="radEmu">
<meta property="og:image" content="https://statdivlab.github.io/radEmu/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">radEmu</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/intro_radEmu_with_phyloseq.html">Introduction to radEmu with phyloseq</a>
    <a class="dropdown-item" href="../articles/intro_radEmu.html">Introduction to radEmu</a>
    <a class="dropdown-item" href="../articles/parallel_radEmu.html">Parallelizing computation for score tests with radEmu</a>
    <a class="dropdown-item" href="../articles/radEmu_clustered_data.html">Using radEmu on clustered data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/statdivlab/radEmu/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using radEmu on clustered data</h1>
                        <h4 data-toc-skip class="author">Sarah Teichman
and Amy Willis</h4>
            
            <h4 data-toc-skip class="date">2024-06-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/statdivlab/radEmu/blob/HEAD/vignettes/radEmu_clustered_data.Rmd" class="external-link"><code>vignettes/radEmu_clustered_data.Rmd</code></a></small>
      <div class="d-none name"><code>radEmu_clustered_data.Rmd</code></div>
    </div>

    
    
<p>First, we will install <code>radEmu</code>, if we haven’t
already.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if (!require("remotes", quietly = TRUE))</span></span>
<span><span class="co">#     install.packages("remotes")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># remotes::install_github("statdivlab/radEmu")</span></span></code></pre></div>
<p>Next, we can load <code>radEmu</code> as well as the
<code>tidyverse</code> package suite.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/statdivlab/radEmu" class="external-link">radEmu</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will explore the use of <code>radEmu</code> with
clustered data. Data with cluster dependence is a common phenomenon in
microbiome studies. This type of dependence can come from experimental
factors such as shared cages or tanks for study animals. It can also
arise from repeated measurements in longitudinal studies.</p>
<p>Sometimes people deal with clustered data via random effects. You
might have seen the syntax <code>+ (1 | cluster)</code>. We (the
<code>radEmu</code> developers) don’t want to make strong assumptions
(such as the random effects being normally distributed), so we handle
cluster dependence using a GEE framework. We like this approach because
it’s robust to many forms of model misspecification, and for this
reason, we find it superior to random effects.</p>
<p>When dependence is not accounted for, statistical inference in
<code>radEmu</code> (and most statistical methods!) assume that all
samples are independent. If you have cluster dependence but assume
independence, you’ll have anti-conservative inference (i.e., p-values
that are smaller than they should be). <strong>Therefore, we strongly
recommend adjusting for cluster dependence if it arose in your sample
collection!</strong></p>
<p>Note that cluster dependence won’t change your estimates (<span class="math inline">\(\hat{\beta}_j\)</span>’s), but it will (most
likely) change your p-values.</p>
<p>Luckily, we have tools to account for cluster dependence implemented
in <code>radEmu</code>! This argument is only implemented from
<code>radEmu</code> v1.2.0.0 forward, so if you are having trouble using
the <code>cluster</code> argument, check that you reinstalled
<code>radEmu</code> recently.</p>
<p>TLDR; the basic syntax is as follows. <code>my_clusters</code> is a
vector of length <span class="math inline">\(n\)</span> (your number of
samples), with observations from the same cluster having the same value
in <code>my_clusters</code>
(e.g. <code>my_clusters = c(1, 1, 2, 2, 3, 4)</code>).</p>
<pre><code><span><span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">covariate</span>,</span>
<span>       data <span class="op">=</span> <span class="va">my_data_frame</span>, </span>
<span>       Y <span class="op">=</span> <span class="va">my_microbial_abundances</span>,</span>
<span>       cluster <span class="op">=</span> <span class="va">my_clusters</span><span class="op">)</span></span></code></pre>
<p>Fun fact! We implemented this functionality because of user requests.
Therefore, if there’s something that you’d like to see that you don’t
see, <a href="https://github.com/statdivlab/radEmu/issues" class="external-link">let us
know</a> and we’ll see what we can do!</p>
</div>
<div class="section level2">
<h2 id="generating-data-with-cluster-dependence">Generating data with cluster dependence<a class="anchor" aria-label="anchor" href="#generating-data-with-cluster-dependence"></a>
</h2>
<p>To start, let’s generate a toy example (10 categories, 60 samples) in
which there is cluster dependence within our data. The way we simulate
data isn’t important; it’s just an illustration. <strong>radEmu can
handle more taxa and samples,</strong> we just did this so that the
vignette builds quickly.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">10</span>; <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="co"># generate design matrix </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cov_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cov <span class="op">=</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># cluster membership </span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">cluster_named</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"cage"</span>, <span class="va">cluster</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="va">cov_dat</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="va">cluster</span></span>
<span><span class="co"># intercepts for each category</span></span>
<span><span class="va">b0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span></span>
<span><span class="co"># coefficients for X1 for each category </span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, length.out <span class="op">=</span> <span class="va">J</span><span class="op">)</span></span>
<span><span class="co"># mean center the coefficients</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="va">b1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">b1</span><span class="op">)</span></span>
<span><span class="co"># set the coefficient for the 3rd category to 4 (why not!?)</span></span>
<span><span class="co"># Note that because of the constraint, we're only able to estimate</span></span>
<span><span class="co"># b1 - mean(b1), which is ~3.9.  </span></span>
<span><span class="va">b1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="co"># generate B coefficient matrix </span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">b0</span>, <span class="va">b1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate data according to a zero-inflated negative binomial distribution</span></span>
<span><span class="co"># the mean model used to simulate this data takes into account the cluster membership</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, J <span class="op">=</span> <span class="va">J</span>, b0 <span class="op">=</span> <span class="va">b0</span>, b1 <span class="op">=</span> <span class="va">b1</span>, distn <span class="op">=</span> <span class="st">"ZINB"</span>, zinb_size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                   zinb_zero_prop <span class="op">=</span> <span class="fl">0.3</span>, mean_count_before_ZI <span class="op">=</span> <span class="fl">100</span>, X <span class="op">=</span> <span class="va">X</span>, cluster <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<p>Let’s just pause to look at the elements of <code>cluster</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">cluster_named</span><span class="op">)</span></span>
<span><span class="co">#&gt; cluster_named</span></span>
<span><span class="co">#&gt; cage1 cage2 cage3 cage4 </span></span>
<span><span class="co">#&gt;    15    15    15    15</span></span></code></pre></div>
<p>So all of the observations from the first cage (or person, tank,
whatever…) have <code>cage1</code> in their corresponding
<code>cluster_named</code> variable.</p>
<p>Let’s fit a model to this data! We know that the log-fold difference
between in the abundance of category 3 when comparing samples that
differ by 1 unit in <span class="math inline">\(X\)</span> is 3.5, so if
we have good power, we will reject the null that <span class="math inline">\(\beta_{X_1, 3} = 0\)</span>. We fit a model
including cluster dependence as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ef_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">cov_dat</span>, </span>
<span>                     Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>                     cluster <span class="op">=</span> <span class="va">cluster_named</span>, </span>
<span>                     test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, j <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can check out the full object, but our estimate is 4.6 and a
p-value for testing that this parameter equals zero is 0.084. Not too
shabby, especially considering that about half of our observations are
zero, and we have a lot of noise in our data (arising from a negative
binomial simulation scheme).</p>
<p>Let’s also compare that to a situation where we mistakenly ignore
clustering. In this case, we expect to have a smaller p-value, because
we are saying that we have more independent observations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ef_no_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cov_dat</span>, </span>
<span>                        Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>                        test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, j <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When we ignore clustering, we get an estimate of the log fold
difference in category 3 across values of our covariate of 4.6 and a
p-value of 0.007. So we can see that our estimates are the same whether
or not we account for cluster, but our p-values are different (because
we are pretending that we have more evidence in the absence of
clustering).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Clausen, Amy Willis, Sarah Teichman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
