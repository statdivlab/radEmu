<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using radEmu on clustered data • radEmu</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using radEmu on clustered data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">radEmu</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/intro_radEmu_with_phyloseq.html">Introduction to radEmu with phyloseq</a></li>
    <li><a class="dropdown-item" href="../articles/intro_radEmu_with_tse.html">Introduction to radEmu with TreeSummarizedExperiment</a></li>
    <li><a class="dropdown-item" href="../articles/intro_radEmu.html">Introduction to radEmu</a></li>
    <li><a class="dropdown-item" href="../articles/parallel_radEmu.html">Parallelizing computation for score tests with radEmu</a></li>
    <li><a class="dropdown-item" href="../articles/radEmu_clustered_data.html">Using radEmu on clustered data</a></li>
    <li><a class="dropdown-item" href="../articles/radEmu_with_reference_taxon.html">Using radEmu with a reference taxon</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/statdivlab/radEmu/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using radEmu on clustered data</h1>
                        <h4 data-toc-skip class="author">Sarah Teichman
and Amy Willis</h4>
            
            <h4 data-toc-skip class="date">2025-03-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/statdivlab/radEmu/blob/main/vignettes/radEmu_clustered_data.Rmd" class="external-link"><code>vignettes/radEmu_clustered_data.Rmd</code></a></small>
      <div class="d-none name"><code>radEmu_clustered_data.Rmd</code></div>
    </div>

    
    
<p>First, we will install <code>radEmu</code>, if we haven’t
already.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if (!require("remotes", quietly = TRUE))</span></span>
<span><span class="co">#     install.packages("remotes")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># remotes::install_github("statdivlab/radEmu")</span></span></code></pre></div>
<p>Next, we can load <code>radEmu</code> as well as the
<code>tidyverse</code> package suite.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/statdivlab/radEmu" class="external-link">radEmu</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will explore the use of <code>radEmu</code> with
clustered data. Data with cluster dependence is a common phenomenon in
microbiome studies. This type of dependence can come from experimental
factors such as shared cages or tanks for study animals. It can also
arise from repeated measurements in longitudinal studies.</p>
<p>Sometimes people deal with clustered data via random effects. You
might have seen the syntax <code>+ (1 | cluster)</code>. We (the
<code>radEmu</code> developers) don’t want to make strong assumptions
(such as the random effects being normally distributed), so we handle
cluster dependence using a GEE framework. We like this approach because
it’s robust to many forms of model misspecification, and for this
reason, we find it superior to random effects.</p>
<p>When dependence is not accounted for, statistical inference in
<code>radEmu</code> (and most statistical methods!) assume that all
samples are independent. If you have cluster dependence but assume
independence, you’ll have anti-conservative inference (i.e., p-values
that are smaller than they should be). <strong>Therefore, we strongly
recommend adjusting for cluster dependence if it arose in your sample
collection!</strong></p>
<p>Note that cluster dependence won’t change your estimates
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>β</mi><mo accent="true">̂</mo></mover><mi>j</mi></msub><annotation encoding="application/x-tex">\hat{\beta}_j</annotation></semantics></math>’s),
but it will (most likely) change your p-values.</p>
<p>Luckily, we have tools to account for cluster dependence implemented
in <code>radEmu</code>! This argument is only implemented from
<code>radEmu</code> v1.2.0.0 forward, so if you are having trouble using
the <code>cluster</code> argument, check that you reinstalled
<code>radEmu</code> recently.</p>
<p>TLDR; the basic syntax is as follows. <code>my_clusters</code> is a
vector of length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
(your number of samples), with observations from the same cluster having
the same value in <code>my_clusters</code>
(e.g. <code>my_clusters = c(1, 1, 2, 2, 3, 4)</code>).</p>
<pre><code><span><span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">covariate</span>,</span>
<span>       data <span class="op">=</span> <span class="va">my_data_frame</span>, </span>
<span>       Y <span class="op">=</span> <span class="va">my_microbial_abundances</span>,</span>
<span>       cluster <span class="op">=</span> <span class="va">my_clusters</span><span class="op">)</span></span></code></pre>
<p>Fun fact! We implemented this functionality because of user requests.
Therefore, if there’s something that you’d like to see that you don’t
see, <a href="https://github.com/statdivlab/radEmu/issues" class="external-link">let us
know</a> and we’ll see what we can do!</p>
</div>
<div class="section level2">
<h2 id="generating-data-with-cluster-dependence">Generating data with cluster dependence<a class="anchor" aria-label="anchor" href="#generating-data-with-cluster-dependence"></a>
</h2>
<p>To start, let’s generate a toy example (10 categories, 60 samples) in
which there is cluster dependence within our data. The way we simulate
data isn’t important; it’s just an illustration. <strong>radEmu can
handle more taxa and samples,</strong> we just did this so that the
vignette builds quickly.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fl">10</span>; <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="co"># generate design matrix </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cov_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cov <span class="op">=</span> <span class="va">X</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># cluster membership </span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">cluster_named</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"cage"</span>, <span class="va">cluster</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="va">cov_dat</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="va">cluster</span></span>
<span><span class="co"># intercepts for each category</span></span>
<span><span class="va">b0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span></span>
<span><span class="co"># coefficients for X1 for each category </span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, length.out <span class="op">=</span> <span class="va">J</span><span class="op">)</span></span>
<span><span class="co"># mean center the coefficients</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="va">b1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">b1</span><span class="op">)</span></span>
<span><span class="co"># set the coefficient for the 3rd category to 4 (why not!?)</span></span>
<span><span class="co"># Note that because of the constraint, we're only able to estimate</span></span>
<span><span class="co"># b1 - mean(b1), which is ~3.9.  </span></span>
<span><span class="va">b1</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="co"># generate B coefficient matrix </span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">b0</span>, <span class="va">b1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate data according to a zero-inflated negative binomial distribution</span></span>
<span><span class="co"># the mean model used to simulate this data takes into account the cluster membership</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu">radEmu</span><span class="fu">:::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>,</span>
<span>                            J <span class="op">=</span> <span class="va">J</span>,</span>
<span>                            b0 <span class="op">=</span> <span class="va">b0</span>,</span>
<span>                            b1 <span class="op">=</span> <span class="va">b1</span>,</span>
<span>                            distn <span class="op">=</span> <span class="st">"ZINB"</span>,</span>
<span>                            zinb_size <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                            zinb_zero_prop <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>                            mean_z <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                            X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                            cluster <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span></span></code></pre></div>
<p>Let’s just pause to look at the elements of <code>cluster</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">cluster_named</span><span class="op">)</span></span>
<span><span class="co">#&gt; cluster_named</span></span>
<span><span class="co">#&gt; cage1 cage2 cage3 cage4 </span></span>
<span><span class="co">#&gt;    15    15    15    15</span></span></code></pre></div>
<p>So all of the observations from the first cage (or person, tank,
whatever…) have <code>cage1</code> in their corresponding
<code>cluster_named</code> variable.</p>
<p>Let’s fit a model to this data! We know that the log-fold difference
between in the abundance of category 3 when comparing samples that
differ by 1 unit in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
is 3.5, so if we have good power, we will reject the null that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mrow><msub><mi>X</mi><mn>1</mn></msub><mo>,</mo><mn>3</mn></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\beta_{X_1, 3} = 0</annotation></semantics></math>.
We fit a model including cluster dependence as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ef_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">cov_dat</span>, </span>
<span>                     Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>                     cluster <span class="op">=</span> <span class="va">cluster_named</span>, </span>
<span>                     test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, j <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Row names are missing from the response matrix Y. We will assume the rows are in the same order as in the covariate matrix X. You are responsible for ensuring the order of your observations is the same in both matrices.</span></span></code></pre></div>
<p>You can check out the full object, but our estimate is 4.2 and a
p-value for testing that this parameter equals zero is 0.03. Not too
shabby, especially considering that about half of our observations are
zero, and we have a lot of noise in our data (arising from a negative
binomial simulation scheme).</p>
<p>Let’s also compare that to a situation where we mistakenly ignore
clustering. In this case, we expect to have a smaller p-value, because
we are saying that we have more independent observations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ef_no_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cov_dat</span>, </span>
<span>                        Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>                        test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">2</span>, j <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Row names are missing from the response matrix Y. We will assume the rows are in the same order as in the covariate matrix X. You are responsible for ensuring the order of your observations is the same in both matrices.</span></span></code></pre></div>
<p>When we ignore clustering, we get an estimate of the log fold
difference in category 3 across values of our covariate of 4.2 and a
p-value of 0.005. So we can see that our estimates are the same whether
or not we account for cluster, but our p-values are different (because
we are pretending that we have more evidence in the absence of
clustering).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Clausen, Amy Willis, Sarah Teichman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
