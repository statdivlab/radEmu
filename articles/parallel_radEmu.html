<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parallelizing computation for score tests with radEmu • radEmu</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parallelizing computation for score tests with radEmu">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">radEmu</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/intro_radEmu_with_phyloseq.html">Introduction to radEmu with phyloseq</a></li>
    <li><a class="dropdown-item" href="../articles/intro_radEmu.html">Introduction to radEmu</a></li>
    <li><a class="dropdown-item" href="../articles/parallel_radEmu.html">Parallelizing computation for score tests with radEmu</a></li>
    <li><a class="dropdown-item" href="../articles/radEmu_clustered_data.html">Using radEmu on clustered data</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/statdivlab/radEmu/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Parallelizing computation for score tests with radEmu</h1>
                        <h4 data-toc-skip class="author">Sarah
Teichman</h4>
            
            <h4 data-toc-skip class="date">2024-09-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/statdivlab/radEmu/blob/main/vignettes/parallel_radEmu.Rmd" class="external-link"><code>vignettes/parallel_radEmu.Rmd</code></a></small>
      <div class="d-none name"><code>parallel_radEmu.Rmd</code></div>
    </div>

    
    
<p>First, we will install <code>radEmu</code>, if we haven’t
already.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if (!require("remotes", quietly = TRUE))</span></span>
<span><span class="co">#     install.packages("remotes")</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># remotes::install_github("statdivlab/radEmu")</span></span></code></pre></div>
<p>Next, we can load <code>radEmu</code> as well as the
<code>tidyverse</code> package suite.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/statdivlab/radEmu" class="external-link">radEmu</a></span><span class="op">)</span></span></code></pre></div>
<p>Finally, we will load the package <code>parallel</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will introduce parallel computing in order to do
more efficient computation for score tests. Our recommendation for
testing statistical hypotheses with small to moderate sample sizes with
<code>radEmu</code> is to run a robust score test. While this test
performs well (we like that it controls Type I error rate even in small
samples!), it takes some time to run, because we need to fit the model
under each null hypothesis. For differential abundance analysis, we
often want to run a hypothesis test for each category (taxon, gene, etc)
that we care about, so this adds up quickly. In order to improve
computational efficiency, we can run these score tests in parallel using
the <code>parallel</code> R package. This will let us take advantage of
having additional cores on personal computers or computing clusters.
Note that we will be using the <code>mclapply</code> function from the
<code>parallel</code> package, which works on Mac and Linux machines,
but does not on Windows. If you are using a Windows machine and would
like a vignette about parallel computing on Windows, please let us know
by opening an issue.</p>
<p>We recommend that before working through this vignette, you start the
an introduction to <code>radEmu</code> in “intro_radEmu.Rmd.”</p>
</div>
<div class="section level2">
<h2 id="setting-up-our-rademu-model-and-running-a-single-score-test">Setting up our radEmu model and running a single score test<a class="anchor" aria-label="anchor" href="#setting-up-our-rademu-model-and-running-a-single-score-test"></a>
</h2>
<p>We’ll use the same Wirbel et al. data as in the introduction
vignette. Recall that the <a href="https://www.nature.com/articles/s41591-019-0406-6" class="external-link">dataset
published by Wirbel et al. (2019)</a> is from a meta-analysis of
case-controls comparing participants with and without colorectal
cancer.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load in sample data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"wirbel_sample"</span><span class="op">)</span></span>
<span><span class="co"># set group to be a factor with levels CTR for control and CRC for cancer</span></span>
<span><span class="va">wirbel_sample</span><span class="op">$</span><span class="va">Group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">wirbel_sample</span><span class="op">$</span><span class="va">Group</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CTR"</span>,<span class="st">"CRC"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># load in abundance data </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"wirbel_otu"</span><span class="op">)</span></span>
<span><span class="co"># save mOTU names</span></span>
<span><span class="va">mOTU_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">wirbel_otu</span><span class="op">)</span></span>
<span><span class="co"># consider taxa in the following genera</span></span>
<span><span class="va">chosen_genera</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Eubacterium"</span>, <span class="st">"Faecalibacterium"</span>, <span class="st">"Fusobacterium"</span>, <span class="st">"Porphyromonas"</span><span class="op">)</span></span>
<span><span class="co"># get taxonomy information from mOTU names</span></span>
<span><span class="va">mOTU_name_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">mOTU_names</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>base_name <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">mOTU_names</span>, <span class="st">"unknown "</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                      <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="st">"uncultured "</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>genus_name <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/word.html" class="external-link">word</a></span><span class="op">(</span><span class="va">base_name</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># restrict to names in chosen genera</span></span>
<span><span class="va">restricted_mOTU_names</span> <span class="op">&lt;-</span> <span class="va">mOTU_name_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">genus_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">chosen_genera</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="co"># pull out observations from a chinese study within the meta-analysis</span></span>
<span><span class="va">ch_study_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">wirbel_sample</span><span class="op">$</span><span class="va">Country</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHI"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># make count matrix for chosen samples and genera</span></span>
<span><span class="va">small_Y</span> <span class="op">&lt;-</span> <span class="va">wirbel_otu</span><span class="op">[</span><span class="va">ch_study_obs</span>, <span class="va">restricted_mOTU_names</span><span class="op">]</span></span>
<span><span class="co"># check for samples with only zero counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">small_Y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># no samples have a count sum of 0 </span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co"># check for genera with only zero counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">small_Y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># one category has a count sum of 0</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co"># remove the one genus with only zero counts</span></span>
<span><span class="va">category_to_rm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">small_Y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">small_Y</span> <span class="op">&lt;-</span> <span class="va">small_Y</span><span class="op">[</span>, <span class="op">-</span><span class="va">category_to_rm</span><span class="op">]</span></span></code></pre></div>
<p>Now that we’ve processed our data, we can fit the <code>radEmu</code>
model. Here we just want to get estimates for our parameters and their
standard errors, but we will avoid running score tests by setting
<code>run_score_tests = FALSE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ch_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">Group</span>, </span>
<span>                 data <span class="op">=</span> <span class="va">wirbel_sample</span><span class="op">[</span><span class="va">ch_study_obs</span>, <span class="op">]</span>,</span>
<span>                 Y <span class="op">=</span> <span class="va">small_Y</span>,</span>
<span>                 run_score_tests <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span></code></pre></div>
<p>In the introduction vignette we found that a meta-mOTU “unknown
Eubacterium [meta_mOTU_v2_7116]” assigned to Eubacteria has a much
higher ratio of abundance (comparing CRC group to control) than is
typical across the mOTUs we included in this analysis, based on the
parameter estimates in <code>ch_fit</code>. We can run a robust score
test to test whether the differential abundance of this mOTU between
cases and controls is significantly different from the differential
abundance of a typical mOTU in our analysis.</p>
<p>In order to run a single robust score test, we will set
<code>run_score_tests = TRUE</code> and include the argument
<code>test_kj</code>. Instead of re-estimating parameters in our model,
we will provide <code>ch_fit</code> to the argument
<code>fitted_model</code> and set <code>refit = FALSE</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mOTU_to_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">restricted_mOTU_names</span>, <span class="st">"7116"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ch_fit</span><span class="op">$</span><span class="va">B</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">rownames</span></span>
<span><span class="co">#&gt; [1] "(Intercept)" "GroupCRC"</span></span>
<span><span class="va">covariate_to_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="st">"GroupCRC"</span> <span class="op">==</span> <span class="va">ch_fit</span><span class="op">$</span><span class="va">B</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">rownames</span><span class="op">)</span></span>
<span><span class="va">robust_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">Group</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">wirbel_sample</span><span class="op">[</span><span class="va">ch_study_obs</span>, <span class="op">]</span>,</span>
<span>                       fitted_model <span class="op">=</span> <span class="va">ch_fit</span>,</span>
<span>                       refit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                       test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="va">covariate_to_test</span>, </span>
<span>                                            j <span class="op">=</span> <span class="va">mOTU_to_test</span><span class="op">)</span>, </span>
<span>                       Y <span class="op">=</span> <span class="va">small_Y</span><span class="op">)</span></span>
<span><span class="va">robust_score</span><span class="op">$</span><span class="va">coef</span><span class="op">$</span><span class="va">pval</span><span class="op">[</span><span class="va">mOTU_to_test</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.301683</span></span></code></pre></div>
<p>Now, we can see that it took a little while to run our robust score
test. If we investigate the coefficient table in our
<code>robust_score</code> output, we can see that we have a p-value of
<code>R robust_score$coef$pval[mOTU_to_test]</code> from our test.</p>
</div>
<div class="section level2">
<h2 id="running-robust-score-tests-in-parallel">Running robust score tests in parallel<a class="anchor" aria-label="anchor" href="#running-robust-score-tests-in-parallel"></a>
</h2>
<p>Now, let’s run some tests in parallel. We will be parallelizing our
code over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
in the argument <code>test_kj</code>. We will assume that you have one
covariate that you want to test, corresponding with a specific column of
your design matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.
However, if you want to run tests for multiple columns of your design
matrix, then you can parallelize over pairs of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
in the argument
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><msub><mi>t</mi><mi>k</mi></msub><mi>j</mi></mrow><annotation encoding="application/x-tex">test_kj</annotation></semantics></math>.</p>
<p>Let’s say that I want to run score tests for the first five mOTUs in
our dataset. First, I need to check the cores on my computer to see a
reasonable amount of cores to parallelize over. I tend to use one fewer
core than the number of cores that I have available.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">ncores</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Next, I will write a function that will be called in parallel. This
function will fit the model under the null and calculate the robust
score test statistics. Note that the output of this function is an
<code>emuFit</code> object.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emuTest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">category</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">score_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/emuFit.html">emuFit</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="op">~</span> <span class="va">Group</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">wirbel_sample</span><span class="op">[</span><span class="va">ch_study_obs</span>, <span class="op">]</span>,</span>
<span>                       fitted_model <span class="op">=</span> <span class="va">ch_fit</span>,</span>
<span>                       refit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                       test_kj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>k <span class="op">=</span> <span class="va">covariate_to_test</span>, </span>
<span>                                            j <span class="op">=</span> <span class="va">category</span><span class="op">)</span>, </span>
<span>                       Y <span class="op">=</span> <span class="va">small_Y</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we can run our score tests in parallel. We’ll just do the first
five. It may take a minute or so, depending on your machine.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">OS.type</span> <span class="op">!=</span> <span class="st">"windows"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># run if we are on a Mac or Linux machine</span></span>
<span>  <span class="va">score_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>                      <span class="va">emuTest</span>,</span>
<span>                      mc.cores <span class="op">=</span> <span class="va">ncores</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># don't run if we are on a Windows machine</span></span>
<span>  <span class="va">score_res</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we can see that this barely took more time than running a single
score test, because we were able to parallelize over cores (on my
laptop, I’m using more than five cores, so I can run all five tests at
the same time). Each p-value can be pulled out of the list as
follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coef</span><span class="op">$</span><span class="va">pval</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="co">## robust score test p-value for the first taxon</span></span>
<span>  <span class="va">score_res</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coef</span><span class="op">$</span><span class="va">pval</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="co">## robust score test p-value for the second taxon</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] 0.03936520 0.03647308</span></span></code></pre></div>
<p>To help organise this information, we can make a coefficient matrix
that combines the information from each component in our list:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">full_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">)</span>, </span>
<span>                       <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">score_res</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coef</span><span class="op">$</span><span class="va">score_stat</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">full_pval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">score_res</span><span class="op">)</span>, </span>
<span>                      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">score_res</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coef</span><span class="op">$</span><span class="va">pval</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">full_coef</span> <span class="op">&lt;-</span> <span class="va">ch_fit</span><span class="op">$</span><span class="va">coef</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">score_stat</span>, <span class="op">-</span><span class="va">pval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">category_num</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>score_stat <span class="op">=</span> <span class="va">full_score</span>,</span>
<span>           pval <span class="op">=</span> <span class="va">full_pval</span><span class="op">)</span></span>
<span>  <span class="va">full_coef</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;   covariate                                                category</span></span>
<span><span class="co">#&gt; 1  GroupCRC Fusobacterium nucleatum s. vincentii [ref_mOTU_v2_0754]</span></span>
<span><span class="co">#&gt; 2  GroupCRC  Fusobacterium nucleatum s. animalis [ref_mOTU_v2_0776]</span></span>
<span><span class="co">#&gt; 3  GroupCRC Fusobacterium nucleatum s. nucleatum [ref_mOTU_v2_0777]</span></span>
<span><span class="co">#&gt; 4  GroupCRC         Faecalibacterium prausnitzii [ref_mOTU_v2_1379]</span></span>
<span><span class="co">#&gt; 5  GroupCRC                  Eubacterium siraeum [ref_mOTU_v2_1387]</span></span>
<span><span class="co">#&gt;   category_num    estimate        se      lower     upper  score_stat</span></span>
<span><span class="co">#&gt; 1            1  1.48637864 0.8966329 -0.2709896 3.2437469 4.245037543</span></span>
<span><span class="co">#&gt; 2            2  2.31317105 0.8271200  0.6920456 3.9342966 4.374848023</span></span>
<span><span class="co">#&gt; 3            3  3.08640472 1.0275200  1.0725026 5.1003069 3.186822346</span></span>
<span><span class="co">#&gt; 4            4 -0.34307573 0.3520406 -1.0330626 0.3469111 0.825349169</span></span>
<span><span class="co">#&gt; 5            5  0.03892098 0.4780368 -0.8980140 0.9758559 0.007383068</span></span>
<span><span class="co">#&gt;         pval</span></span>
<span><span class="co">#&gt; 1 0.03936520</span></span>
<span><span class="co">#&gt; 2 0.03647308</span></span>
<span><span class="co">#&gt; 3 0.07423418</span></span>
<span><span class="co">#&gt; 4 0.36362082</span></span>
<span><span class="co">#&gt; 5 0.93152621</span></span></code></pre></div>
<p>The column containing our p-values is called <code>pval</code>.</p>
<p>Happy testing!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Clausen, Amy Willis, Sarah Teichman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
